<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mtron Tapper - Firebase Entegre</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        /* Ã–nceki stiller (Beyaz arkaplan, mavi butonlar vb.) */
        body {
            background-color: #ffffff; 
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container { width: 100%; max-width: 400px; padding: 20px; box-sizing: border-box; }
        h1 { color: #1a1a1a; font-size: 1.5em; margin-bottom: 20px; }
        .balance-card { background-color: #0088cc; color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .balance-amount { font-size: 2.5em; font-weight: bold; margin: 5px 0; }
        .referral-box { background-color: #f0f0f0; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .link-text { font-size: 0.9em; word-break: break-all; margin-bottom: 15px; font-weight: 600; }
        #copy-button { background-color: #0088cc; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; width: 100%; }
        #status-message { margin-top: 15px; font-weight: 500; color: #FFA500; }
        /* YÃ¼kleme animasyonu */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>Mtron Tapper Davet AlanÄ±</h1>

    <div class="balance-card">
        <p style="margin: 0; font-size: 1em;">MEVCUT BAKÄ°YENÄ°Z</p>
        <div id="user-balance" class="balance-amount">0.00 MTRON</div>
    </div>
    
    <div class="referral-box">
        <p style="font-size: 0.8em; color: #666;">KiÅŸisel Davet Linkiniz:</p>
        <div id="referral-link" class="link-text">YÃ¼kleniyor...</div>
        <button id="copy-button">Link Kopyala</button>
    </div>

    <div id="status-message">Firebase'den veri bekleniyor... <div class="loader"></div></div>
</div>

<script>
    // GerÃ§ek bot kullanÄ±cÄ± adÄ±nÄ±z
    const BOT_USERNAME = "MtronTapper_bot"; 

    // Sizin SaÄŸladÄ±ÄŸÄ±nÄ±z Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDBjyaKi_6V9S48lsga5RJfSEzxGvq4dkc",
        authDomain: "mtron-1d3c9.firebaseapp.com",
        databaseURL: "https://mtron-1d3c9-default-rtdb.firebaseio.com",
        projectId: "mtron-1d3c9",
        storageBucket: "mtron-1d3c9.firebasestorage.app",
        messagingSenderId: "735786797791",
        appId: "1:735786797791:web:a8ede2bd403f4fd4c2776a",
        measurementId: "G-5PEZ5DBVXH"
    };

    // Firebase'i BaÅŸlat
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(); // Realtime Database'i al

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.Telegram || !window.Telegram.WebApp) {
            document.getElementById('status-message').textContent = "HATA: Telegram SDK yÃ¼klenemedi.";
            return;
        }
        
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        const initDataUnsafe = WebApp.initDataUnsafe;
        const currentUser = initDataUnsafe.user;
        const currentUserId = currentUser ? currentUser.id : "USER_ID_YOK";
        const referrerCode = initDataUnsafe.start_param || null; // Davet kodu

        // 1. Davet Linkini OluÅŸtur ve GÃ¶rÃ¼ntÃ¼le
        const botLink = `https://t.me/${BOT_USERNAME}?start=${currentUserId}`; 
        document.getElementById('referral-link').textContent = botLink;

        // 2. Telegram ButonlarÄ±nÄ± Ayarla
        initializeButtons(WebApp, botLink);

        // 3. KullanÄ±cÄ± Verisini Firebase'e Kaydet/Oku
        handleUserAuthentication(currentUserId, referrerCode);
    });

    // --- Fonksiyonlar ---

    function initializeButtons(WebApp, link) {
        WebApp.MainButton.setText('ARKADAÅžINI DAVET ET VE PAYLAÅž');
        WebApp.MainButton.show();
        
        WebApp.MainButton.onClick(() => {
            const shareText = `ðŸš€ Mtron Tapper'da kazanmak iÃ§in hemen katÄ±l! Ä°ÅŸte benim davet linkim: ${link}`;
            WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareText)}`);
        });

        document.getElementById('copy-button').addEventListener('click', () => {
            navigator.clipboard.writeText(link).then(() => {
                WebApp.showPopup({
                    message: "Davet linki kopyalandÄ±!",
                    buttons: [{ id: 'ok', type: 'ok', text: 'Tamam' }]
                });
            });
        });
    }

    async function handleUserAuthentication(userId, referrerCode) {
        const statusEl = document.getElementById('status-message');
        const userRef = database.ref('users/' + userId);

        // Veriyi oku ve kullanÄ±cÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
        userRef.once('value')
            .then((snapshot) => {
                let userData = snapshot.val();

                if (userData) {
                    // KullanÄ±cÄ± Zaten KayÄ±tlÄ±
                    console.log("KullanÄ±cÄ± zaten kayÄ±tlÄ±.", userData);
                    statusEl.textContent = `âœ… Veri AlÄ±ndÄ±: HoÅŸ geldiniz, ${userData.username || 'KullanÄ±cÄ±'}!`;
                    statusEl.style.color = '#28a745'; 
                    document.getElementById('user-balance').textContent = `${userData.balance.toFixed(2)} MTRON`;
                } else {
                    // Yeni KullanÄ±cÄ± KaydÄ± ve Davet KontrolÃ¼
                    const initialBalance = 100.00; // BaÅŸlangÄ±Ã§ bonusu
                    userData = {
                        telegram_id: userId,
                        username: Telegram.WebApp.initDataUnsafe.user.username || 'N/A',
                        balance: initialBalance,
                        referred_by: (referrerCode && String(referrerCode) !== String(userId)) ? referrerCode : null, // Kendi kendine daveti engelle
                        referrals_count: 0,
                        created_at: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Yeni kullanÄ±cÄ±yÄ± kaydet
                    return userRef.set(userData).then(() => {
                        statusEl.textContent = `ðŸŽ‰ Yeni KayÄ±t! BaÅŸlangÄ±Ã§ bonusu verildi.`;
                        statusEl.style.color = '#28a745';
                        document.getElementById('user-balance').textContent = `${initialBalance.toFixed(2)} MTRON`;

                        // Davet eden varsa Ã¶dÃ¼llendir (Backend mantÄ±ÄŸÄ± simÃ¼lasyonu)
                        if (userData.referred_by) {
                            rewardReferrer(userData.referred_by, userId);
                        }
                    });
                }
            })
            .catch(error => {
                console.error("Firebase HatasÄ±:", error);
                statusEl.textContent = `âŒ Firebase HatasÄ±: ${error.message}`;
                statusEl.style.color = '#dc3545';
            });
    }

    function rewardReferrer(referrerId, newUserId) {
        const referrerRef = database.ref('users/' + referrerId);
        const rewardAmount = 200.00; // Davet edene verilecek Ã¶dÃ¼l

        // Transaction ile gÃ¼venli bakiye artÄ±ÅŸÄ±
        referrerRef.transaction((currentData) => {
            if (currentData) {
                // Sadece ilk davetlerde Ã¶dÃ¼llendirmek iÃ§in bir kontrol eklenebilir.
                currentData.balance = (currentData.balance || 0) + rewardAmount;
                currentData.referrals_count = (currentData.referrals_count || 0) + 1;
                // Davet edene, kimi davet ettiÄŸini gÃ¶steren bir alt kayÄ±t ekleme
                if (!currentData.invited) currentData.invited = {};
                currentData.invited[newUserId] = true; 
            }
            return currentData;
        }).then(() => {
            console.log(`Davet eden ${referrerId} Ã¶dÃ¼llendirildi.`);
        }).catch(error => {
            console.error("Referans Ã¶dÃ¼llendirme hatasÄ±:", error);
        });
    }
</script>
</body>
</html>
