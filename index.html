<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mtron Tapper - Davet Sistemi Testi</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        body {
            background-color: #ffffff; 
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 400px; padding: 20px; box-sizing: border-box; }
        h1 { color: #1a1a1a; font-size: 1.5em; margin-bottom: 20px; }
        .balance-card { 
            background-color: #0088cc; 
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); 
        }
        .balance-amount { font-size: 2.5em; font-weight: bold; margin: 5px 0; }
        .referral-box { background-color: #f0f0f0; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .link-text { font-size: 0.9em; word-break: break-all; margin-bottom: 15px; font-weight: 600; }
        #copy-button { 
            background-color: #0088cc; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            transition: background-color 0.2s; 
            width: 100%; 
        }
        #status-message { margin-top: 15px; font-weight: 500; color: #FFA500; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>Mtron Tapper Davet Alanƒ±</h1>

    <div class="balance-card">
        <p style="margin: 0; font-size: 1em;">MEVCUT BAKƒ∞YENƒ∞Z</p>
        <div id="user-balance" class="balance-amount">0.00 MTRON</div>
    </div>
    
    <div class="referral-box">
        <p style="font-size: 0.8em; color: #666;">Ki≈üisel Davet Linkiniz:</p>
        <div id="referral-link" class="link-text">Y√ºkleniyor...</div>
        <button id="copy-button">Link Kopyala</button>
    </div>

    <div id="status-message">Firebase'den veri bekleniyor... <div class="loader"></div></div>
</div>

<script>
    // 1. YAPILANDIRMALAR
    const BOT_USERNAME = "MtronTapper_bot"; 
    
    // Sizin Saƒüladƒ±ƒüƒ±nƒ±z Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDBjyaKi_6V9S48lsga5RJfSEzxGvq4dkc",
        authDomain: "mtron-1d3c9.firebaseapp.com",
        databaseURL: "https://mtron-1d3c9-default-rtdb.firebaseio.com",
        projectId: "mtron-1d3c9",
        storageBucket: "mtron-1d3c9.firebasestorage.app",
        messagingSenderId: "735786797791",
        appId: "1:735786797791:web:a8ede2bd403f4fd4c2776a",
        measurementId: "G-5PEZ5DBVXH"
    };

    // Firebase'i Ba≈ülat
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(); 

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.Telegram || !window.Telegram.WebApp) {
            document.getElementById('status-message').textContent = "HATA: Telegram SDK y√ºklenemedi.";
            return;
        }
        
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        const initDataUnsafe = WebApp.initDataUnsafe;
        const currentUser = initDataUnsafe.user;
        const currentUserId = currentUser ? currentUser.id : "USER_ID_YOK";
        const referrerCode = initDataUnsafe.start_param || null;

        // 2. ARAY√úZ KURULUMU
        const botLink = `https://t.me/${BOT_USERNAME}?start=${currentUserId}`; 
        document.getElementById('referral-link').textContent = botLink;

        initializeButtons(WebApp, botLink);

        // 3. DAVET VE BAKIYE MANTIƒûINI BA≈ûLAT
        handleUserAuthentication(currentUserId, referrerCode);
    });

    // --- TEMEL FONKSƒ∞YONLAR ---

    function initializeButtons(WebApp, link) {
        WebApp.MainButton.setText('ARKADA≈ûINI DAVET ET VE PAYLA≈û');
        WebApp.MainButton.show();
        
        WebApp.MainButton.onClick(() => {
            const shareText = `üöÄ Mtron Tapper'a gel ve kazanmaya ba≈üla! Benim davet linkim: ${link}`;
            WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareText)}`);
        });

        document.getElementById('copy-button').addEventListener('click', () => {
            navigator.clipboard.writeText(link).then(() => {
                WebApp.showPopup({
                    message: "Davet linki kopyalandƒ±!",
                    buttons: [{ id: 'ok', type: 'ok', text: 'Tamam' }]
                });
            });
        });
    }

    async function handleUserAuthentication(userId, referrerCode) {
        const statusEl = document.getElementById('status-message');
        const userRef = database.ref('users/' + userId);

        userRef.once('value')
            .then((snapshot) => {
                let userData = snapshot.val();

                if (userData) {
                    // Kullanƒ±cƒ± Zaten Kayƒ±tlƒ±: Bakiye ve verileri g√∂ster
                    statusEl.textContent = `‚úÖ Veri Alƒ±ndƒ±: Ho≈ü geldiniz, ${userData.username || 'Kullanƒ±cƒ±'}!`;
                    statusEl.style.color = '#28a745'; 
                    document.getElementById('user-balance').textContent = `${userData.balance.toFixed(2)} MTRON`;
                } else {
                    // Yeni Kullanƒ±cƒ±: Kaydet ve √ñd√ºllendir
                    const initialBalance = 100.00; // Yeni kullanƒ±cƒ±ya ba≈ülangƒ±√ß bonusu
                    userData = {
                        telegram_id: userId,
                        username: Telegram.WebApp.initDataUnsafe.user.username || 'N/A',
                        balance: initialBalance,
                        referred_by: (referrerCode && String(referrerCode) !== String(userId)) ? referrerCode : null, 
                        referrals_count: 0,
                        created_at: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Yeni kullanƒ±cƒ±yƒ± kaydet
                    return userRef.set(userData).then(() => {
                        statusEl.textContent = `üéâ Yeni Kayƒ±t! Ba≈ülangƒ±√ß bonusu verildi.`;
                        statusEl.style.color = '#28a745';
                        document.getElementById('user-balance').textContent = `${initialBalance.toFixed(2)} MTRON`;

                        // Davet eden varsa: 200 Puan Bonusu Ver!
                        if (userData.referred_by) {
                            rewardReferrer(userData.referred_by, userId);
                        }
                    });
                }
            })
            .catch(error => {
                // Bu hata b√ºy√ºk ihtimalle "permission_denied" hatasƒ±dƒ±r.
                statusEl.innerHTML = `‚ùå Firebase Hatasƒ±: ${error.message}. <br> **√á√∂z√ºm i√ßin Firebase Kurallarƒ±nƒ± Kontrol Edin!**`;
                statusEl.style.color = '#dc3545';
            });
    }

    // DAVET EDENE BONUS VERME FONKSƒ∞YONU
    function rewardReferrer(referrerId, newUserId) {
        const referrerRef = database.ref('users/' + referrerId);
        const rewardAmount = 200.00; // <-- TALEP EDƒ∞LEN 200 BONUS Mƒ∞KTARI

        // Transaction ile g√ºvenli bakiye artƒ±≈üƒ±
        referrerRef.transaction((currentData) => {
            if (currentData) {
                currentData.balance = (currentData.balance || 0) + rewardAmount; 
                currentData.referrals_count = (currentData.referrals_count || 0) + 1;
                
                if (!currentData.invited) currentData.invited = {};
                currentData.invited[newUserId] = true; 
            }
            return currentData;
        }).then(() => {
            console.log(`Davet eden ${referrerId} 200 puan ile √∂d√ºllendirildi.`);
        }).catch(error => {
            console.error("Referans √∂d√ºllendirme hatasƒ±:", error);
        });
    }
</script>
</body>
</html>
